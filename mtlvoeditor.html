<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音声入力対応 多言語対訳エディタ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* マイクボタンのスタイル */
        #micButton {
            background-color: #d1d5db; /* gray-300 */
            padding: 0.3rem; /* 少し小さめ */
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            display: inline-flex; /* ボタンをインライン表示 */
            align-items: center;
            justify-content: center;
            width: 32px; /* 固定幅 */
            height: 32px; /* 固定高さ */
            margin-left: 8px; /* タイトルとの間隔 */
            border: none;
        }
        #micButton:hover {
            background-color: #9ca3af; /* gray-400 */
        }
        #micButton.listening {
            background-color: #ef4444; /* red-500 */
        }
        #micButton svg {
            width: 18px;
            height: 18px;
            fill: #4b5563; /* gray-600 */
        }
        #micButton.listening svg {
            fill: white;
        }
        /* 認識中のステータス（オプション）*/
        #speechStatus {
            font-size: 0.8rem;
            color: #6b7280; /* gray-500 */
            margin-left: 8px;
            display: none; /* Initially hidden */
        }
        #speechStatus.active {
            display: inline;
        }

        /* ローディングスピナー */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: none; /* Initially hidden */
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #feedbackArea {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s;
        }
        #feedbackArea.show {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }
    </style>
</head>
<body class="bg-gray-50 p-4">
    <div class="container mx-auto p-6 bg-white rounded-lg shadow-md">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                音声入力対応 多言語対訳エディタ
                <button id="micButton" title="音声入力開始/停止">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h144c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"/></svg>
                </button>
                <span id="speechStatus"></span>
            </h1>
            <p class="text-gray-600 mt-2" id="description">左側のテキストエリアに入力するか、マイクボタンを押して話すと、右側に翻訳が表示されます。</p>
            <p class="text-red-600 text-sm mt-1"><strong>注意:</strong> 音声認識機能はChrome, Edge, Safari等の一部のブラウザでのみ動作します。マイクへのアクセス許可が必要です。</p>
            <p class="text-red-600 text-sm mt-1"><strong>注意:</strong> このエディタは動作デモのために非公式の翻訳APIを使用しています。</p> </header>
        <main class="mb-8">
            <div id="controlsArea" class="flex flex-col sm:flex-row justify-center items-center mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                <div id="layoutControls" class="flex justify-center space-x-2">
                    <button data-layout="horizontal" class="layout-btn bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">左右</button>
                    <button data-layout="vertical" class="layout-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">上下</button>
                </div>
                <div class="flex items-center space-x-2">
                    <label for="sourceLangSelect" class="text-sm font-medium text-gray-700">入力:</label>
                    <select id="sourceLangSelect" name="source_language" class="text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></select>
                    <label for="targetLangSelect" class="text-sm font-medium text-gray-700">出力:</label>
                    <select id="targetLangSelect" name="target_language" class="text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
            </div>

            <div id="textAreas" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <section id="inputSection">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3 flex items-center" id="inputLanguageTitle">入力エリア</h2>
                    <textarea id="inputText" class="w-full h-[300px] border border-gray-300 rounded-md p-4 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none bg-white shadow-sm" placeholder="ここにテキストを入力するか、マイクボタンを押して話してください" aria-label="入力テキストエリア"></textarea>
                    <div class="flex justify-between mt-2">
                        <button id="saveInputButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">保存</button>
                        <button id="clearInputButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">クリア</button>
                        <button id="copyInputButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">コピー</button>
                    </div>
                </section>
                <section id="translatedSection">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3 flex items-center" id="translatedLanguageTitle">翻訳エリア <div class="loader" id="loadingSpinner"></div></h2>
                    <textarea id="translatedText" class="w-full h-[300px] border border-gray-300 rounded-md p-4 text-gray-600 bg-gray-100 focus:outline-none shadow-sm" placeholder="翻訳結果がここに表示されます" readonly aria-live="polite" aria-label="翻訳結果エリア"></textarea>
                    <div class="flex justify-between mt-2">
                        <button id="saveTranslatedButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">保存</button>
                        <button id="clearTranslatedButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">クリア</button>
                        <button id="copyTranslatedButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">コピー</button>
                    </div>
                </section>
            </div>
        </main>
        <footer class="text-center text-gray-500 text-sm mt-4">
            <p>翻訳の精度は、原文の内容や文脈、選択言語によって異なる場合があります。</p>
            <p>音声認識機能は一部のブラウザでのみ利用可能です。</p>
        </footer>
    </div>
    <div id="feedbackArea"></div>

    <script>
        (function() {
            // --- DOM Elements ---
            const micButton = document.getElementById('micButton');
            const speechStatus = document.getElementById('speechStatus');
            const sourceLangSelect = document.getElementById('sourceLangSelect');
            const targetLangSelect = document.getElementById('targetLangSelect');
            const inputTextarea = document.getElementById('inputText');
            const translatedTextarea = document.getElementById('translatedText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const feedbackArea = document.getElementById('feedbackArea');
            const layoutButtons = document.querySelectorAll('.layout-btn');

            // --- Configuration & State ---
            const DEBOUNCE_DELAY = 500;
            const FEEDBACK_DURATION = 2500;
            const freeGoogleTranslateUrl = 'https://translate.googleapis.com/translate_a/single';
            const LANGUAGES = {
                'ja': '日本語', 'en': '英語', 'zh-CN': '中国語 (簡体)', 'ko': '韓国語',
                'de': 'ドイツ語', 'fr': 'フランス語', 'es': 'スペイン語', 'it': 'イタリア語', 'ru': 'ロシア語'
            };
            let sourceLang = 'ja';
            let targetLang = 'en';
            let currentLayout = 'horizontal';
            let debounceTimer;
            let feedbackTimer;
            let isTranslating = false;
            let isRecognizing = false;

            // --- Web Speech API ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition = null;

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.interimResults = true;
                recognition.continuous = false;

                recognition.onstart = () => {
                    isRecognizing = true;
                    micButton.classList.add('listening');
                    speechStatus.textContent = '認識中...';
                    speechStatus.classList.add('active');
                    console.log('Speech recognition started.');
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    // 認識中の途中結果をテキストエリアに反映
                    inputTextarea.value = interimTranscript;

                    // 最終結果が得られたら、既存のテキストに追加して翻訳をトリガー
                    if (finalTranscript) {
                        const currentText = inputTextarea.value;
                        inputTextarea.value = currentText + finalTranscript;
                        localStorage.setItem('inputText', inputTextarea.value);
                        translateText(inputTextarea.value);
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    let errorMessage = '音声認識エラーが発生しました。';
                    if (event.error === 'no-speech') {
                        errorMessage = '音声が検出されませんでした。';
                    } else if (event.error === 'audio-capture') {
                        errorMessage = 'マイクにアクセスできませんでした。';
                    } else if (event.error === 'not-allowed') {
                        errorMessage = 'マイクの使用が許可されていません。';
                    } else if (event.error === 'network') {
                        errorMessage = 'ネットワークエラーが発生しました。';
                    } else if (event.error === 'service-not-allowed'){
                        errorMessage = 'ブラウザまたはOSにより音声認識サービスが許可されていません。';
                    }
                    showFeedback(errorMessage, true);
                    if (isRecognizing) {
                        recognition.stop();
                    }
                };

                recognition.onend = () => {
                    isRecognizing = false;
                    micButton.classList.remove('listening');
                    speechStatus.classList.remove('active');
                    speechStatus.textContent = '';
                    console.log('Speech recognition ended.');
                };

            } else {
                console.warn('Web Speech API is not supported in this browser.');
                if(micButton) {
                    micButton.disabled = true;
                    micButton.title = 'お使いのブラウザは音声認識に対応していません。';
                    micButton.style.cursor = 'not-allowed';
                    micButton.style.opacity = '0.5';
                }
            }

            // --- Helper Functions ---
            function getLangName(code) {
                return LANGUAGES[code] || code;
            }

            function showFeedback(message, isError = false) {
                feedbackArea.textContent = message;
                feedbackArea.classList.add('show');
                clearTimeout(feedbackTimer);
                feedbackTimer = setTimeout(() => {
                    feedbackArea.classList.remove('show');
                }, FEEDBACK_DURATION);
            }

            function updateUIForLanguage() {
                document.getElementById('inputLanguageTitle').textContent = `入力エリア (${getLangName(sourceLang)})`;
                document.getElementById('translatedLanguageTitle').textContent = `翻訳エリア (${getLangName(targetLang)})`;
                document.getElementById('description').textContent = `左側のテキストエリアに入力するか、マイクボタンを押して話すと、右側に${getLangName(targetLang)}の翻訳が表示されます。`;
            }

            function updateDescription() {
                document.getElementById('description').textContent = `左側のテキストエリアに入力するか、マイクボタンを押して話すと、右側に${getLangName(targetLang)}の翻訳が表示されます。`;
            }

            function setLayout(layout) {
                currentLayout = layout;
                const textAreas = document.getElementById('textAreas');
if (layout === 'vertical') {
                    textAreas.classList.remove('md:grid-cols-2');
                    textAreas.classList.add('grid-cols-1');
                } else {
                    textAreas.classList.remove('grid-cols-1');
                    textAreas.classList.add('md:grid-cols-2');
                }
                localStorage.setItem('translationEditorLayout', layout);
                layoutButtons.forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-300', 'text-gray-800');
                    if (btn.dataset.layout === layout) {
                        btn.classList.add('bg-blue-500', 'text-white');
                    }
                });
            }

            function populateDropdowns() {
                for (const code in LANGUAGES) {
                    const sourceOption = document.createElement('option');
                    sourceOption.value = code;
                    sourceOption.textContent = LANGUAGES[code];
                    sourceLangSelect.appendChild(sourceOption);

                    const targetOption = document.createElement('option');
                    targetOption.value = code;
                    targetOption.textContent = LANGUAGES[code];
                    targetLangSelect.appendChild(targetOption);
                }
                sourceLangSelect.value = sourceLang;
                targetLangSelect.value = targetLang;
            }

            function saveTextToFile(text, langCode) {
                const filename = `translation_${langCode}_${new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '')}.txt`;
                const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showFeedback('テキストを保存しました。');
            }

            function setupActionButtons(buttonId, textarea, action) {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.addEventListener('click', () => {
                        const text = textarea.value;
                        const langCode = (textarea === inputTextarea) ? sourceLang : targetLang;
                        if (action === 'save' && text.trim()) {
                            saveTextToFile(text, langCode);
                        } else if (action === 'clear') {
                            textarea.value = '';
                            localStorage.setItem(textarea.id, '');
                            if (textarea === inputTextarea) {
                                translatedTextarea.value = '';
                                localStorage.setItem('translatedText', '');
                            }
                            showFeedback('テキストエリアをクリアしました。');
                        } else if (action === 'copy' && text.trim()) {
                            navigator.clipboard.writeText(text)
                                .then(() => showFeedback('テキストをクリップボードにコピーしました。'))
                                .catch(err => showFeedback('コピーに失敗しました。', true));
                        }
                    });
                }
            }

            async function translateText(text) {
                if (!text.trim()) {
                    translatedTextarea.value = '';
                    localStorage.setItem('translatedText', '');
                    return;
                }
                isTranslating = true;
                loadingSpinner.style.display = 'inline-block';
                try {
                    const response = await fetch(`${freeGoogleTranslateUrl}?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data && data[0] && data[0][0] && data[0][0][0]) {
                        translatedTextarea.value = data[0][0][0];
                        localStorage.setItem('translatedText', translatedTextarea.value);
                    } else {
                        translatedTextarea.value = '翻訳に失敗しました。';
                        localStorage.setItem('translatedText', '翻訳に失敗しました。');
                        showFeedback('翻訳に失敗しました。', true);
                    }
                } catch (error) {
                    console.error('Translation error:', error);
                    translatedTextarea.value = '翻訳エラーが発生しました。';
                    localStorage.setItem('translatedText', '翻訳エラーが発生しました。');
                    showFeedback('翻訳エラーが発生しました。', true);
                } finally {
                    loadingSpinner.style.display = 'none';
                    isTranslating = false;
                }
            }

            // --- Event Listeners ---
            layoutButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    setLayout(event.target.dataset.layout);
                });
            });

            inputTextarea.addEventListener('input', (event) => {
                const textToTranslate = event.target.value;
                localStorage.setItem('inputText', textToTranslate);
                clearTimeout(debounceTimer);
                if (textToTranslate.trim() && !isTranslating) {
                    debounceTimer = setTimeout(() => { translateText(textToTranslate); }, DEBOUNCE_DELAY);
                } else if (!textToTranslate.trim()) {
                    translatedTextarea.value = '';
                    localStorage.setItem('translatedText', '');
                }
            });

            sourceLangSelect.addEventListener('change', (event) => {
                if (isRecognizing) {
                    recognition.stop();
                    speechStatus.textContent = '停止しました。';
                    speechStatus.classList.add('active');
                    setTimeout(() => speechStatus.classList.remove('active'), 1000);
                }
                const newSourceLang = event.target.value;
                if (newSourceLang === targetLang) {
                    const oldSourceLang = sourceLang;
                    targetLang = oldSourceLang;
                    targetLangSelect.value = targetLang;
                    localStorage.setItem('targetLang', targetLang);
                }
                sourceLang = newSourceLang;
                localStorage.setItem('sourceLang', sourceLang);
                updateUIForLanguage();
                if (inputTextarea.value.trim()) {
                    clearTimeout(debounceTimer);
                    translateText(inputTextarea.value);
                } else {
                    translatedTextarea.value = '';
                    localStorage.setItem('translatedText', '');
                }
                // 音声認識言語を更新 (認識中の場合、再開時に適用される)
                if (recognition) {
                    recognition.lang = sourceLang;
                }
            });

            targetLangSelect.addEventListener('change', (event) => {
                const newTargetLang = event.target.value;
                if (newTargetLang === sourceLang) {
                    const oldTargetLang = targetLang;
                    sourceLang = oldTargetLang;
                    sourceLangSelect.value = sourceLang;
                    localStorage.setItem('sourceLang', sourceLang);
                }
                targetLang = newTargetLang;
                localStorage.setItem('targetLang', targetLang);
                updateUIForLanguage();
                if (inputTextarea.value.trim()) {
                    clearTimeout(debounceTimer);
                    translateText(inputTextarea.value);
                }
            });

            // Mic Button Listener
            if (micButton && recognition) {
                micButton.addEventListener('click', () => {
                    if (!recognition) return;

                    if (isRecognizing) {
                        recognition.stop();
                        speechStatus.textContent = '停止しました。';
                        speechStatus.classList.add('active');
                        setTimeout(() => speechStatus.classList.remove('active'), 1000);
                    } else {
                        // 認識開始前に入力言語を設定 (sourceLangSelectの変更時にも更新される)
                        recognition.lang = sourceLang;
                        try {
                            recognition.start();
                            speechStatus.textContent = '認識中...';
                            speechStatus.classList.add('active');
                        } catch (e) {
                            console.error("Error starting speech recognition:", e);
                            showFeedback("音声認識を開始できませんでした。マイクの準備ができているか確認してください。", true);
                            speechStatus.textContent = 'エラー';
                            speechStatus.classList.add('active');
                            setTimeout(() => speechStatus.classList.remove('active'), 2000);
                        }
                    }
                });
            }

            // Setup action buttons
            setupActionButtons('saveInputButton', inputTextarea, 'save');
            setupActionButtons('clearInputButton', inputTextarea, 'clear');
            setupActionButtons('copyInputButton', inputTextarea, 'copy');
            setupActionButtons('saveTranslatedButton', translatedTextarea, 'save');
            setupActionButtons('clearTranslatedButton', translatedTextarea, 'clear');
            setupActionButtons('copyTranslatedButton', translatedTextarea, 'copy');

            // --- Initialization ---
            function initialize() {
                const savedLayout = localStorage.getItem('translationEditorLayout') || 'horizontal';
                setLayout(savedLayout);
                sourceLang = localStorage.getItem('sourceLang') || 'ja';
                targetLang = localStorage.getItem('targetLang') || 'en';
                if (!LANGUAGES[sourceLang]) sourceLang = 'ja';
                if (!LANGUAGES[targetLang] || targetLang === sourceLang) {
                    targetLang = (sourceLang === 'en') ? 'ja' : 'en';
                    localStorage.setItem('targetLang', targetLang);
                }
                populateDropdowns();
                inputTextarea.value = localStorage.getItem('inputText') || '';
                translatedTextarea.value = localStorage.getItem('translatedText') || '';
                updateUIForLanguage();

                if (!SpeechRecognition) {
                    showFeedback("お使いのブラウザは音声認識に対応していません。", true);
                }
            }

            initialize();

        })();
    </script>
</body>
</html>
